name: Telegram Bot Fast

on:
  schedule:
    - cron: '*/1 * * * *'  # ÐšÐ°Ð¶Ð´ÑƒÑŽ Ð¼Ð¸Ð½ÑƒÑ‚Ñƒ
  workflow_dispatch:

jobs:
  fast-bot:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: pip install pyTelegramBotAPI gspread google-auth
      
    - name: Run bot
      env:
        GOOGLE_CREDS_JSON: ${{ secrets.GOOGLE_CREDS_JSON }}
      run: |
        echo "ðŸ¤– Ð—ÐÐŸÐ£Ð¡Ðš Ð‘ÐžÐ¢Ð ÐšÐÐ–Ð”Ð£Ð® ÐœÐ˜ÐÐ£Ð¢Ð£"
        
        # ÐŸÐ¸ÑˆÐµÐ¼ Ñ„Ð¸ÐºÑÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¹ ÐºÐ¾Ð´ Ð±Ð¾Ñ‚Ð°
        cat > bot_runner.py << 'EOF'
#!/usr/bin/env python3
import os
import telebot
import gspread
import json
from datetime import datetime
from google.oauth2.service_account import Credentials

print("="*50)
print("ðŸ¤– Ð‘ÐžÐ¢ 'Ð”ÐÐÐ˜Ð›Ð ÐœÐÐ¡Ð¢Ð•Ð ' Ð—ÐÐŸÐ£Ð©Ð•Ð")
print("="*50)

# ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸
BOT_TOKEN = "8133979508:AAERCJ0vygaJ-eSymRGEk1w5kzRZrp7SGi8"
ADMIN_IDS = [5537549230]
SPREADSHEET_ID = "1H6gkSXURYSWvXJFtjT8m7ESLvgFluOiR0g2wqrnz2MM"
GOOGLE_CREDS_JSON = os.getenv("GOOGLE_CREDS_JSON", "")

print("âœ… Ð’ÑÐµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ñ‹")

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð±Ð¾Ñ‚Ð°
bot = telebot.TeleBot(BOT_TOKEN)

# ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹ update_id Ð¸Ð· Ñ„Ð°Ð¹Ð»Ð°
def get_last_offset():
    try:
        if os.path.exists('/tmp/last_offset.txt'):
            with open('/tmp/last_offset.txt', 'r') as f:
                return int(f.read().strip())
    except:
        pass
    return None

# Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ update_id
def save_last_offset(offset):
    try:
        with open('/tmp/last_offset.txt', 'w') as f:
            f.write(str(offset))
    except:
        pass

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð°Ð´Ð¼Ð¸Ð½Ð°
def is_admin(user_id):
    return user_id in ADMIN_IDS

# ÐžÑÐ½Ð¾Ð²Ð½Ð°Ñ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ
def main():
    # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ offset
    offset = get_last_offset()
    if offset:
        print(f"ðŸ“Š Last offset: {offset}")
    else:
        print("ðŸ“Š First run, starting from beginning")
        offset = None
    
    try:
        # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ
        updates = bot.get_updates(offset=offset, timeout=5, allowed_updates=["message"])
        print(f"ðŸ“¨ ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹: {len(updates)}")
        
        if updates:
            # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ð¹ offset
            new_offset = updates[-1].update_id + 1
            save_last_offset(new_offset)
            
            # ÐžÐ±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ ÐºÐ°Ð¶Ð´Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ
            for update in updates:
                if update.message and update.message.text:
                    msg = update.message
                    text = msg.text.strip()
                    user_id = msg.from_user.id
                    chat_id = msg.chat.id
                    
                    print(f"ðŸ‘¤ User {user_id}: {text}")
                    
                    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð°Ð´Ð¼Ð¸Ð½Ð°
                    if is_admin(user_id):
                        if text == "/start":
                            bot.send_message(chat_id, 
                                "ðŸ¦· *Ð‘Ð¾Ñ‚ Ð”Ð°Ð½Ð¸Ð»Ð° ÐœÐ°ÑÑ‚ÐµÑ€*\n\n"
                                "âœ… Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¾!\n"
                                "ðŸ“… " + datetime.now().strftime("%d.%m.%Y %H:%M"),
                                parse_mode="Markdown")
                        else:
                            bot.send_message(chat_id, 
                                f"âœ… ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¾: {text}\n"
                                f"ðŸ• {datetime.now().strftime('%H:%M:%S')}")
                    else:
                        bot.send_message(chat_id, "âŒ Ð”Ð¾ÑÑ‚ÑƒÐ¿ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð°")
        
        print("âœ… ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°")
        
    except Exception as e:
        print(f"âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: {e}")

if __name__ == "__main__":
    main()
EOF

        # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð±Ð¾Ñ‚Ð°
        python bot_runner.py
