name: Telegram Bot Fast

on:
  schedule:
    - cron: '*/1 * * * *'  # ÐšÐÐ–Ð”Ð£Ð® ÐœÐ˜ÐÐ£Ð¢Ð£
  workflow_dispatch:

jobs:
  fast-bot:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: pip install pyTelegramBotAPI gspread google-auth
      
    - name: Run bot with offset
      env:
        GOOGLE_CREDS_JSON: ${{ secrets.GOOGLE_CREDS_JSON }}
      run: |
        echo "ðŸ¤– Ð—ÐÐŸÐ£Ð¡Ðš Ð‘ÐžÐ¢Ð Ð¡ Ð¤Ð˜ÐšÐ¡ÐžÐœ Ð”Ð›Ð¯ TELEGRAM"
        echo "ðŸ‘‰ Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ„Ð°Ð¹Ð» Ñ offset..."
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ„Ð°Ð¹Ð» Ð´Ð»Ñ Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÐµÐ³Ð¾ update_id
        cat > bot_fixed.py << 'EOF'
#!/usr/bin/env python3
import os
import telebot
import gspread
import json
import re
from datetime import datetime
from google.oauth2.service_account import Credentials

print("="*60)
print("ðŸ¤– Ð‘ÐžÐ¢ 'Ð”ÐÐÐ˜Ð›Ð ÐœÐÐ¡Ð¢Ð•Ð ' Ð—ÐÐŸÐ£Ð©Ð•Ð")
print("="*60)

# ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸
BOT_TOKEN = "8133979508:AAERCJ0vygaJ-eSymRGEk1w5kzRZrp7SGi8"
ADMIN_IDS = [5537549230]
SPREADSHEET_ID = "1H6gkSXURYSWvXJFtjT8m7ESLvgFluOiR0g2wqrnz2MM"
GOOGLE_CREDS_JSON = os.getenv("GOOGLE_CREDS_JSON", "")

print("ðŸ”§ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐº:")
print(f"   Ð¢Ð¾ÐºÐµÐ½ Ð±Ð¾Ñ‚Ð°: {'âœ…' if BOT_TOKEN else 'âŒ'}")
print(f"   ÐÐ´Ð¼Ð¸Ð½Ñ‹: {ADMIN_IDS}")
print(f"   ID Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹: âœ…")
print(f"   Google JSON: {'âœ…' if GOOGLE_CREDS_JSON else 'âŒ'}")

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ offset
def get_last_offset():
    try:
        with open('/tmp/last_offset.txt', 'r') as f:
            return int(f.read().strip())
    except:
        return None

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ offset
def save_last_offset(offset):
    try:
        with open('/tmp/last_offset.txt', 'w') as f:
            f.write(str(offset))
    except:
        pass

# ÐžÑÐ½Ð¾Ð²Ð½Ð°Ñ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ
def main():
    bot = telebot.TeleBot(BOT_TOKEN)
    
    # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹ offset
    last_offset = get_last_offset()
    
    print(f"ðŸ“¡ ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ñ offset: {last_offset}")
    
    try:
        # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ñ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ð¼ offset
        updates = bot.get_updates(offset=last_offset, timeout=10)
        print(f"ðŸ“¨ ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¾ {len(updates)} Ð½Ð¾Ð²Ñ‹Ñ… ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹")
        
        if updates:
            # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ð¹ offset
            new_offset = updates[-1].update_id + 1
            save_last_offset(new_offset)
            print(f"ðŸ’¾ Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½ Ð½Ð¾Ð²Ñ‹Ð¹ offset: {new_offset}")
            
            # ÐžÐ±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ
            for update in updates:
                if update.message and update.message.text:
                    text = update.message.text.strip()
                    user_id = update.message.from_user.id
                    print(f"ðŸ‘¤ ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ {user_id}: {text}")
                    
                    if user_id in ADMIN_IDS:
                        bot.send_message(update.message.chat.id, 
                            f"âœ… Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¾: {text}\n"
                            f"ðŸ“… Ð”Ð°Ñ‚Ð°: {datetime.now().strftime('%d.%m.%Y %H:%M')}")
                    else:
                        bot.send_message(update.message.chat.id, "âŒ Ð”Ð¾ÑÑ‚ÑƒÐ¿ Ð·Ð°Ð¿Ñ€ÐµÑ‰ÐµÐ½")
        else:
            print("ðŸ“­ ÐÐ¾Ð²Ñ‹Ñ… ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ Ð½ÐµÑ‚")
            
    except Exception as e:
        print(f"âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: {e}")

if __name__ == "__main__":
    main()
EOF

        echo "ðŸ‘‰ Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð±Ð¾Ñ‚Ð°..."
        python bot_fixed.py
